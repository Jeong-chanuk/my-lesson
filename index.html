<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¦¬ë¯¸ì—„ íšŒì›ì œ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8f9fa; --blue: #4dabf7; --red: #ff8787; --dark: #343a40; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--dark); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1 { margin-bottom: 5px; }
        .info { color: #868e96; margin-bottom: 30px; font-size: 14px; }
        #lesson-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 15px; width: 100%; max-width: 900px; }
        .slot { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; border: 2px solid transparent; cursor: pointer; }
        .available { border-color: #e7f5ff; }
        .available:hover { transform: translateY(-5px); border-color: var(--blue); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .booked { background: #fff5f5; border-color: #ffe3e3; cursor: not-allowed; opacity: 0.8; }
        .time-text { font-size: 1.2em; font-weight: bold; display: block; margin-bottom: 5px; }
        .available .time-text { color: var(--blue); }
        .booked .time-text { color: var(--red); }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .available .badge { background: #e7f5ff; color: #1971c2; }
        .booked .badge { background: #ffe3e3; color: #c92a2a; }
        .user-name { display: block; margin-top: 8px; font-size: 13px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ğŸ“… ìˆ˜ì—… ì˜ˆì•½ ì‹œìŠ¤í…œ</h1>
    <p class="info">ë“±ë¡ëœ ì„±í•¨ì„ ì…ë ¥í•˜ì—¬ ë‚¨ì€ íšŸìˆ˜ ë‚´ì—ì„œ ì˜ˆì•½ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>

    <div id="lesson-list">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <script>
        // ì„ ìƒë‹˜ì˜ ì‹¤ì œ URLê³¼ KEYë¡œ ìœ ì§€í•´ì£¼ì„¸ìš”!
        const SUPABASE_URL = 'https://stjmbuhxmdnogmzmeqmt.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_GJe263qFZFStFSXh2oT3AA_D2wUEqmD'; 

        // 1. ìˆ˜ì—… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function fetchLessons() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/MyClass?select=*`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                const data = await res.json();
                data.sort((a, b) => a.id - b.id);
                render(data);
            } catch (err) {
                console.error("ìˆ˜ì—… ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:", err);
            }
        }

        function render(lessons) {
            const list = document.getElementById('lesson-list');
            list.innerHTML = '';
            lessons.forEach(l => {
                const div = document.createElement('div');
                div.className = `slot ${l.is_booked ? 'booked' : 'available'}`;
                div.innerHTML = `
                    <span class="time-text">${l.time}</span>
                    <span class="badge">${l.is_booked ? 'ì˜ˆì•½ì™„ë£Œ' : 'ì˜ˆì•½ê°€ëŠ¥'}</span>
                    ${l.is_booked ? `<span class="user-name">ğŸ‘¤ ${l.student_name}ë‹˜</span>` : ''}
                `;
                if (!l.is_booked) div.onclick = () => handleBooking(l.id, l.time);
                list.appendChild(div);
            });
        }

        // 2. ì˜ˆì•½ ë¡œì§ (ëŒ€ì†Œë¬¸ì ìˆ˜ì • ë° ì—ëŸ¬ ë°©ì§€ ê°•í™”)
        async function handleBooking(lessonId, time) {
            const name = prompt("ë“±ë¡ëœ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
            if (!name) return;

            try {
                // [ìˆ˜ì •] í…Œì´ë¸” ì´ë¦„ì„ Students(ëŒ€ë¬¸ì)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.
                const studentRes = await fetch(`${SUPABASE_URL}/rest/v1/Students?name=eq.${name}&select=*`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                
                if (!studentRes.ok) throw new Error("í•™ìƒ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨");
                
                const students = await studentRes.json();

                if (students.length === 0) {
                    alert(`'${name}'ë‹˜ì€ ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë¦„ì…ë‹ˆë‹¤. Students í…Œì´ë¸”ì˜ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.`);
                    return;
                }

                const student = students[0];
                const total = Number(student.total_slots);
                const used = Number(student.used_slots);
                const remaining = total - used;

                if (remaining <= 0) {
                    alert(`${name}ë‹˜, ì´ë²ˆ ë‹¬ ì˜ˆì•½ ê°€ëŠ¥ íšŸìˆ˜(${total}íšŒ)ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.`);
                    return;
                }

                // ì˜ˆì•½ ì§„í–‰ (MyClass ì—…ë°ì´íŠ¸)
                const bookRes = await fetch(`${SUPABASE_URL}/rest/v1/MyClass?id=eq.${lessonId}`, {
                    method: 'PATCH',
                    headers: { 
                        'apikey': SUPABASE_KEY, 
                        'Authorization': `Bearer ${SUPABASE_KEY}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ is_booked: true, student_name: name })
                });

                if (bookRes.ok) {
                    // í•™ìƒ ì‚¬ìš© íšŸìˆ˜ ì°¨ê° (Students ì—…ë°ì´íŠ¸)
                    await fetch(`${SUPABASE_URL}/rest/v1/Students?id=eq.${student.id}`, {
                        method: 'PATCH',
                        headers: { 
                            'apikey': SUPABASE_KEY, 
                            'Authorization': `Bearer ${SUPABASE_KEY}`, 
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ used_slots: used + 1 })
                    });

                    alert(`${name}ë‹˜ ì˜ˆì•½ ì™„ë£Œ! (ë‚¨ì€ íšŸìˆ˜: ${remaining - 1}íšŒ)`);
                    fetchLessons();
                }
            } catch (err) {
                console.error("ì˜ˆì•½ ê³¼ì •ì—ì„œ ì—ëŸ¬ ë°œìƒ:", err);
                alert("ì˜ˆì•½ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†” ì°½ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
        }

        fetchLessons();
    </script>
</body>
</html>