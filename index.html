<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¦¬ë¯¸ì—„ íšŒì›ì œ ì˜ˆì•½ ì‹œìŠ¤í…œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8f9fa; --blue: #4dabf7; --red: #ff8787; --dark: #343a40; --white: #ffffff; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--dark); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* ë¡œê·¸ì¸ ì„¹ì…˜ */
        #login-section { background: var(--white); padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); text-align: center; width: 100%; max-width: 400px; margin-top: 50px; }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 14px; margin-bottom: 5px; color: #666; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        #login-btn { width: 100%; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* ë©”ì¸ ëŒ€ì‹œë³´ë“œ (ì²˜ìŒì—” ìˆ¨ê¹€) */
        #main-dashboard { display: none; width: 100%; max-width: 900px; }
        .user-info-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .user-info-card h2 { margin: 0; font-size: 1.2rem; }
        .status-badge { background: #e7f5ff; color: #1971c2; padding: 8px 15px; border-radius: 30px; font-weight: bold; }

        /* ì‹œê°„í‘œ ê·¸ë¦¬ë“œ */
        #lesson-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 15px; }
        .slot { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: 0.2s; border: 2px solid transparent; }
        .available { border-color: #e7f5ff; cursor: pointer; }
        .available:hover { transform: translateY(-5px); border-color: var(--blue); }
        .booked { background: #fff5f5; opacity: 0.7; }
        .my-booking { background: #ebfbee; border-color: #40c057; border-style: dashed; }
        
        .time-text { font-size: 1.1em; font-weight: bold; display: block; margin-bottom: 8px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .available .badge { background: #e7f5ff; color: #1971c2; }
        .booked .badge { background: #ffe3e3; color: #c92a2a; }
        .my-booking .badge { background: #d3f9d8; color: #2b8a3e; }
    </style>
</head>
<body>

    <div id="login-section">
        <h1>Welcome!</h1>
        <p style="color:#888; margin-bottom:20px;">ì„±í•¨ê³¼ ì—°ë½ì²˜ ë’·ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
        <div class="input-group">
            <label>ì´ë¦„</label>
            <input type="text" id="user-name" placeholder="í™ê¸¸ë™">
        </div>
        <div class="input-group">
            <label>ì—°ë½ì²˜ ë’·ìë¦¬ (4ìë¦¬)</label>
            <input type="password" id="user-phone" placeholder="1234">
        </div>
        <button id="login-btn" onclick="handleLogin()">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="main-dashboard">
        <div class="user-info-card">
            <div>
                <h2 id="welcome-msg">ì•ˆë…•í•˜ì„¸ìš”, ë‹˜!</h2>
                <p id="sub-msg" style="margin:5px 0 0; font-size:14px; color:#666;"></p>
            </div>
            <div class="status-badge" id="slots-count">ë‚¨ì€ íšŸìˆ˜: -íšŒ</div>
        </div>

        <h3 style="margin-bottom:15px;">ğŸ“… ìˆ˜ê°• ì‹ ì²­ ê°€ëŠ¥í•œ ì‹œê°„í‘œ</h3>
        <div id="lesson-list"></div>
        
        <button onclick="location.reload()" style="margin-top:30px; background:none; border:none; color:#aaa; cursor:pointer; text-decoration:underline;">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://stjmbuhxmdnogmzmeqmt.supabase.co'; 
        const SUPABASE_KEY = 'sb_publishable_GJe263qFZFStFSXh2oT3AA_D2wUEqmD'; 

        let currentUser = null;

        // [ë¡œê·¸ì¸ ì²˜ë¦¬]
        async function handleLogin() {
            const name = document.getElementById('user-name').value.trim();
            const phone = document.getElementById('user-phone').value.trim();

            if(!name || !phone) {
                alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            try {
                // Name(ëŒ€ë¬¸ì)ê³¼ phone ì»¬ëŸ¼ìœ¼ë¡œ ê²€ìƒ‰
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Students?Name=eq.${name}&phone=eq.${phone}&select=*`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                const users = await res.json();

                if (users.length === 0) {
                    alert("ì¼ì¹˜í•˜ëŠ” í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„ê³¼ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    return;
                }

                currentUser = users[0];
                showDashboard();
            } catch (err) {
                console.error(err);
                alert("ì ‘ì† ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // [ëŒ€ì‹œë³´ë“œ ì „í™˜]
        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            
            const remaining = currentUser.total_slots - currentUser.used_slots;
            document.getElementById('welcome-msg').innerText = `ì•ˆë…•í•˜ì„¸ìš”, ${currentUser.Name}ë‹˜!`;
            document.getElementById('sub-msg').innerText = `ì „ì²´ ìˆ˜ê°•ê¶Œ ${currentUser.total_slots}íšŒ ì¤‘ ${currentUser.used_slots}íšŒë¥¼ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.`;
            document.getElementById('slots-count').innerText = `ë‚¨ì€ íšŸìˆ˜: ${remaining}íšŒ`;

            fetchLessons();
        }

        // [ìˆ˜ì—… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°]
        async function fetchLessons() {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/MyClass?select=*`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const data = await res.json();
            data.sort((a, b) => a.id - b.id);
            render(data);
        }

        function render(lessons) {
            const list = document.getElementById('lesson-list');
            list.innerHTML = '';

            lessons.forEach(l => {
                const isMyBooking = l.is_booked && l.student_name === currentUser.Name;
                const div = document.createElement('div');
                
                let statusClass = 'available';
                let statusText = 'ì˜ˆì•½ê°€ëŠ¥';
                
                if (l.is_booked) {
                    if (isMyBooking) {
                        statusClass = 'my-booking';
                        statusText = 'ë‚´ ì˜ˆì•½';
                    } else {
                        statusClass = 'booked';
                        statusText = 'ì˜ˆì•½ë¶ˆê°€';
                    }
                }

                div.className = `slot ${statusClass}`;
                div.innerHTML = `
                    <span class="time-text">${l.time}</span>
                    <span class="badge">${statusText}</span>
                `;
                
                if (statusClass === 'available') {
                    div.onclick = () => handleBooking(l.id);
                }
                list.appendChild(div);
            });
        }

        // [ì˜ˆì•½ ì§„í–‰]
        async function handleBooking(lessonId) {
            const remaining = currentUser.total_slots - currentUser.used_slots;
            if (remaining <= 0) {
                alert("ìˆ˜ê°• íšŸìˆ˜ë¥¼ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤.");
                return;
            }

            if (!confirm("ì´ ì‹œê°„ìœ¼ë¡œ ì˜ˆì•½ì„ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            // 1. ìˆ˜ì—… í…Œì´ë¸” ì—…ë°ì´íŠ¸
            const bookRes = await fetch(`${SUPABASE_URL}/rest/v1/MyClass?id=eq.${lessonId}`, {
                method: 'PATCH',
                headers: { 
                    'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ is_booked: true, student_name: currentUser.Name })
            });

            if (bookRes.ok) {
                // 2. í•™ìƒ íšŸìˆ˜ ì°¨ê°
                const newUsed = Number(currentUser.used_slots) + 1;
                await fetch(`${SUPABASE_URL}/rest/v1/Students?id=eq.${currentUser.id}`, {
                    method: 'PATCH',
                    headers: { 
                        'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ used_slots: newUsed })
                });

                alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                // ë°ì´í„° ë¡œì»¬ ê°±ì‹  ë° ì¬ë Œë”ë§
                currentUser.used_slots = newUsed;
                showDashboard();
            }
        }
    </script>
</body>
</html>