<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ê´€ë¦¬ì í†µí•© ëª¨ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue: #339af0;
            --green: #28a745;
            --red: #ff6b6b;
            --gray: #f8f9fa;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--gray);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .admin-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        h2,
        h3 {
            color: var(--blue);
            margin-top: 0;
            text-align: center;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        /* ì‹œê°„í‘œ ê·¸ë¦¬ë“œ */
        .time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .time-btn {
            padding: 10px;
            background: #eee;
            color: #333;
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
        }

        .time-btn.active {
            background: var(--blue);
            color: white;
        }

        /* í•™ìƒ ê´€ë¦¬ í…Œì´ë¸” */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .admin-table th {
            background: #f1f3f5;
            padding: 10px;
            font-size: 13px;
            border-bottom: 2px solid #dee2e6;
        }

        .admin-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        /* ì›”ê°„ ë‹¬ë ¥ */
        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .cal-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
        }

        .cal-day {
            background: white;
            min-height: 80px;
            padding: 5px;
            font-size: 11px;
            box-sizing: border-box;
            position: relative;
        }

        .res-item {
            background: #e7f5ff;
            color: #0056b3;
            padding: 2px;
            margin-top: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
    </style>
</head>

<body>

    <div class="admin-card">
        <h2>ğŸ“… ìˆ˜ì—… ì‹œê°„í‘œ ê°œì„¤</h2>
        <div class="input-group">
            <label>ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="lesson-date" onchange="fetchDaySchedules()">
        </div>
        <div id="time-grid" class="time-grid"></div>
    </div>

    <div class="admin-card">
        <h3>ğŸ—“ï¸ ì „ì²´ ì˜ˆì•½ í˜„í™©</h3>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button onclick="moveMonth(-1)" style="width:auto; padding:5px 15px;">â—€</button>
            <span id="current-month-label" style="font-weight:bold; font-size:18px;"></span>
            <button onclick="moveMonth(1)" style="width:auto; padding:5px 15px;">â–¶</button>
        </div>
        <div id="calendar-grid"></div>
    </div>

    <div class="admin-card">
        <h3>ğŸ‘¥ í•™ìƒ ë“±ë¡ ë° ê´€ë¦¬</h3>
        <div id="student-list-container">ë¡œë”© ì¤‘...</div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <h4>â• ìƒˆ í•™ìƒ ì¶”ê°€</h4>
        <div style="display: flex; gap: 8px;">
            <input type="text" id="new-name" placeholder="í•™ìƒ ì´ë¦„">
            <button onclick="addNewStudent()" style="width: 100px; background: var(--green);">ë“±ë¡</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://stjmbuhxmdnogmzmeqmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GJe263qFZFStFSXh2oT3AA_D2wUEqmD';
        const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' };

        let viewDate = new Date();

        window.onload = () => {
            initTimeGrid();
            refreshDashboard();
        };

        // --- 1. ì‹œê°„í‘œ ê´€ë¦¬ ---
        function initTimeGrid() {
            const grid = document.getElementById('time-grid');
            const times = ["14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00"];
            grid.innerHTML = times.map(t => `<div class="time-btn" id="time-${t.replace(':', '')}" onclick="toggleSchedule('${t}')">${t}</div>`).join('');
        }

        async function fetchDaySchedules() {
            const date = document.getElementById('lesson-date').value;
            if (!date) return;
            // ClassSchedules ë˜ëŠ” Schedules ë“± ì‚¬ìš©í•˜ì‹œëŠ” í…Œì´ë¸”ëª…ì— ë§ì¶° ìˆ˜ì • í•„ìš” (í˜„ì¬ ì´ë¯¸ì§€ì—” ClassSchedules ë³´ì„)
            const res = await fetch(`${SUPABASE_URL}/rest/v1/ClassSchedules?lesson_date=eq.${date}`, { headers });
            const data = await res.json();
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            if (Array.isArray(data)) {
                data.forEach(s => {
                    const id = `time-${s.lesson_time.replace(':', '')}`;
                    if (document.getElementById(id)) document.getElementById(id).classList.add('active');
                });
            }
        }

        async function toggleSchedule(time) {
            const date = document.getElementById('lesson-date').value;
            if (!date) return alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
            const btn = document.getElementById(`time-${time.replace(':', '')}`);
            const isActive = btn.classList.contains('active');

            if (!isActive) {
                await fetch(`${SUPABASE_URL}/rest/v1/ClassSchedules`, {
                    method: 'POST', headers, body: JSON.stringify({ lesson_date: date, lesson_time: time })
                });
            } else {
                await fetch(`${SUPABASE_URL}/rest/v1/ClassSchedules?lesson_date=eq.${date}&lesson_time=eq.${time}`, { method: 'DELETE', headers });
            }
            fetchDaySchedules();
        }

        // --- 2. ëŒ€ì‹œë³´ë“œ (ë‹¬ë ¥ + í•™ìƒëª©ë¡) ---
        async function refreshDashboard() {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth() + 1;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            document.getElementById('current-month-label').innerText = `${year}ë…„ ${month}ì›”`;

            try {
                const [stdRes, slotRes, resRes] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/Students?select=id,Name`, { headers }),
                    // month -> month_key ë¡œ ìˆ˜ì •
                    fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots?month_key=eq.${monthKey}`, { headers }),
                    fetch(`${SUPABASE_URL}/rest/v1/Reservations?lesson_date=gte.${monthKey}-01&lesson_date=lte.${monthKey}-31`, { headers })
                ]);

                const students = await stdRes.json();
                const rawSlots = await slotRes.json();
                const rawRes = await resRes.json();

                // 400 ì—ëŸ¬ ì‹œì—ë„ ë¹ˆ ë°°ì—´ë¡œ ì²˜ë¦¬í•˜ì—¬ 'find is not a function' ì—ëŸ¬ ë°©ì§€
                const monthlySlots = Array.isArray(rawSlots) ? rawSlots : [];
                const reservations = Array.isArray(rawRes) ? rawRes : [];

                renderStudentTable(students, monthlySlots, reservations);
                if (typeof renderCalendar === 'function') renderCalendar(reservations);
            } catch (e) {
                console.error("ë°ì´í„° ê°±ì‹  ì¤‘ ì˜¤ë¥˜:", e);
            }
        }

        function renderStudentTable(students, monthlySlots, reservations) {
            let html = `
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ì´ë²ˆ ë‹¬ ë°°ì •</th>
                    <th>ì‚¬ìš©/ì”ì—¬</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>`;

            students.forEach(s => {
                // total_slots -> allowed_slots ë¡œ ìˆ˜ì •
                const slotData = monthlySlots.find(m => m.student_id === s.id);
                const assigned = slotData ? slotData.allowed_slots : 0;

                // ì˜ˆì•½ ë°ì´í„°ì—ì„œ í•™ìƒ IDì™€ ì¼ì¹˜í•˜ëŠ” ê°œìˆ˜ ê³„ì‚°
                const used = reservations.filter(r => Number(r.student_id) === s.id).length;
                const remaining = assigned - used;

                html += `
            <tr>
                <td><strong>${s.Name}</strong></td>
                <td>
                    <input type="number" value="${assigned}" 
                           onchange="updateTotalSlots(${s.id}, this.value)" 
                           style="width:45px; text-align:center;"> íšŒ
                </td>
                <td>
                    <span style="color:#0056b3; font-weight:bold;">${used}</span> / 
                    <span style="color:${remaining < 0 ? 'red' : 'black'}">${remaining}</span>
                </td>
                <td>
                    <button onclick="delStudent(${s.id})" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px;">ì‚­ì œ</button>
                </td>
            </tr>`;
            });
            document.getElementById('student-list-container').innerHTML = html + `</tbody></table>`;
        }

        async function addNewStudent() {
            const name = document.getElementById('new-name').value;
            if (!name) return;
            // total_slotsë¥¼ ì½”ë“œì—ì„œ ì™„ì „íˆ ì œê±°í•˜ì—¬ 400 ì—ëŸ¬ ë°©ì§€
            const res = await fetch(`${SUPABASE_URL}/rest/v1/Students`, {
                method: 'POST', headers: { ...headers, 'Prefer': 'return=minimal' },
                body: JSON.stringify({ Name: name })
            });
            if (res.ok) { document.getElementById('new-name').value = ''; refreshDashboard(); }
        }

        function renderCalendar(reservations) {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);

            const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            const lastDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="cal-day"></div>`;
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayRes = reservations.filter(r => r.lesson_date === dateStr);
                const resHtml = dayRes.map(r => `<div class="res-item" onclick="deleteRes('${r.id}')">${r.lesson_time} ${r.student_id}</div>`).join('');
                grid.innerHTML += `<div class="cal-day"><strong>${d}</strong>${resHtml}</div>`;
            }
        }

        async function deleteRes(id) {
            if (!confirm("ì˜ˆì•½ì„ ì‚­ì œí• ê¹Œìš”?")) return;
            await fetch(`${SUPABASE_URL}/rest/v1/Reservations?id=eq.${id}`, { method: 'DELETE', headers });
            refreshDashboard();
        }

        async function delStudent(id) {
            if (!confirm("í•™ìƒì„ ì‚­ì œí• ê¹Œìš”?")) return;
            await fetch(`${SUPABASE_URL}/rest/v1/Students?id=eq.${id}`, { method: 'DELETE', headers });
            refreshDashboard();
        }

        function moveMonth(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            refreshDashboard();
        }

        async function updateTotalSlots(studentId, newCount) {
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth() + 1;
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;

            // 1. ë¨¼ì € í•´ë‹¹ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì¡°íšŒ)
            const checkRes = await fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots?student_id=eq.${studentId}&month_key=eq.${monthKey}`, {
                headers: headers
            });
            const existingData = await checkRes.json();

            let res;
            if (existingData && existingData.length > 0) {
                // 2. ë°ì´í„°ê°€ ì´ë¯¸ ìˆë‹¤ë©´? -> PATCH (ìˆ˜ì •) ìš”ì²­ì„ ë³´ëƒ„
                res = await fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots?student_id=eq.${studentId}&month_key=eq.${monthKey}`, {
                    method: 'PATCH',
                    headers: headers,
                    body: JSON.stringify({
                        allowed_slots: parseInt(newCount)
                    })
                });
            } else {
                // 3. ë°ì´í„°ê°€ ì—†ë‹¤ë©´? -> POST (ìƒˆë¡œ ì¶”ê°€) ìš”ì²­ì„ ë³´ëƒ„
                res = await fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        student_id: studentId,
                        month_key: monthKey,
                        allowed_slots: parseInt(newCount)
                    })
                });
            }

            if (res.ok) {
                console.log("íšŸìˆ˜ ì—…ë°ì´íŠ¸ ì„±ê³µ");
                refreshDashboard(); // í™”ë©´ ìˆ˜ì¹˜ ê°±ì‹ 
            } else {
                const err = await res.json();
                console.error("ì €ì¥ ì‹¤íŒ¨:", err);
            }
        }
    </script>
</body>

</html>