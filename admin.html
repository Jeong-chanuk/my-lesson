<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ê´€ë¦¬ì ëª¨ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --blue: #339af0;
            --red: #ff6b6b;
            --gray: #f8f9fa;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: var(--gray);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .admin-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 500px;
        }

        h2 {
            margin-top: 0;
            color: var(--blue);
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 15px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .schedule-list {
            margin-top: 30px;
            width: 100%;
            max-width: 500px;
        }

        .schedule-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .status-on {
            color: var(--blue);
            font-weight: bold;
        }

        .status-off {
            color: #aaa;
            text-decoration: line-through;
        }

        .del-btn {
            background: var(--red);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }

        /* 1. ì „ì²´ ê²©ì ì„¤ì •: 7ì—´ë¡œ ê°•ì œ ê³ ì • */
        #admin-calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            gap: 1px;
            background-color: #dee2e6;
            border: 1px solid #dee2e6;
            margin-top: 20px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* 2. ë‚ ì§œ ì¹¸ ì„¤ì •: 6ëª… ì˜ˆì•½ì„ ìœ„í•´ ì„¸ë¡œ ê¸¸ì´ë¥¼ ì¶©ë¶„íˆ í™•ë³´ */
        .calendar-day {
            background-color: #fff;
            min-height: 160px;
            /* ê¸°ë³¸ ê¸¸ì´ë¥¼ ë„‰ë„‰í•˜ê²Œ 160pxë¡œ ì„¤ì • */
            height: auto;
            /* 6ëª… ë„˜ì–´ê°€ë©´ ìë™ìœ¼ë¡œ ë” ê¸¸ì–´ì§ */
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        /* 1. ì˜ˆì•½ ë±ƒì§€: ì•„ì£¼ ì–‡ê³  ì§„í•œ íŒŒë€ìƒ‰ ìŠ¤íƒ€ì¼ */
        .admin-res-badge {
            background-color: #e7f5ff !important;
            /* ì—°í•œ íŒŒë‘ ë°°ê²½ */
            color: #0056b3 !important;
            /* ì§„í•œ íŒŒë‘ ê¸€ì */
            border-left: 3px solid #0056b3 !important;
            /* ì™¼ìª½ ê°•ì¡° ì„  */

            /* í¬ê¸° ì¡°ì ˆì˜ í•µì‹¬: ì—¬ë°±ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤ */
            padding: 1px 4px !important;
            margin: 1px 0 !important;
            font-size: 11px !important;
            /* ê¸€ì í¬ê¸°ë¥¼ ì‘ê²Œ */
            line-height: 1.2 !important;
            /* ì¤„ ê°„ê²©ì„ ì¢ê²Œ */

            border-radius: 3px !important;
            display: flex !important;
            align-items: center !important;
            white-space: nowrap;
            /* í•œ ì¤„ë¡œ í‘œì‹œ */
            overflow: hidden;
            text-overflow: ellipsis;
            /* ì´ë¦„ ê¸¸ë©´ ì í‘œì‹œ(...) */
            cursor: default;
        }

        /* 2. ì‹œê°„ í…ìŠ¤íŠ¸ë§Œ ë” ì§„í•˜ê²Œ ê°•ì¡° */
        .res-time {
            font-weight: 800 !important;
            margin-right: 4px !important;
            color: #004085 !important;
        }

        /* 3. ë‚ ì§œ ì¹¸ ìì²´ì˜ ì„¸ë¡œ ê¸¸ì´ í™•ë³´ */
        .calendar-day {
            min-height: 160px !important;
            /* 6ëª… ì˜ˆì•½ì„ ë‹¤ ë³´ì—¬ì£¼ê¸° ìœ„í•œ ë†’ì´ */
            padding: 4px !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 1px !important;
            /* ë±ƒì§€ ì‚¬ì´ ê°„ê²©ì„ ìµœì†Œí™” */
        }

        /* 4. ìš”ì¼ ì´ë¦„ (ì¼~í† ) */
        .calendar-header {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
            font-size: 13px;
            color: #495057;
            border-bottom: 2px solid #dee2e6;


            width: fit-content !important;
            /* ğŸ‘ˆ í•µì‹¬: ê¸€ì ê¸¸ì´ì— ë”± ë§ê²Œ ë„ˆë¹„ë¥¼ ì œí•œí•¨ */
            align-self: flex-start !important;
            /* ğŸ‘ˆ í•µì‹¬: ì™¼ìª½ ì •ë ¬í•˜ë©° ëŠ˜ì–´ë‚˜ì§€ ì•Šê²Œ í•¨ */

            /* í˜¹ì‹œ ëª°ë¼ í•œ ë²ˆ ë” í™•ì¸í•˜ëŠ” ìŠ¬ë¦¼ ì„¤ì • */
            padding: 1px 5px !important;
            margin: 1px 0 !important;
            min-height: 18px !important;
            /* ë„ˆë¬´ ì–‡ì•„ì§€ëŠ” ê²ƒ ë°©ì§€ */
        }
    </style>
</head>

<body>

    <div class="admin-card">
        <h2>ğŸ“… ìˆ˜ì—… ì‹œê°„í‘œ ê´€ë¦¬ (ë²„íŠ¼ì‹)</h2>
        <div class="input-group">
            <label>ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="lesson-date" onchange="fetchDaySchedules()">
        </div>

        <label style="margin-bottom: 10px; display: block;">ì‹œê°„ ì„¤ì • (íŒŒë€ìƒ‰: í™œì„±í™” / íšŒìƒ‰: ë¹„í™œì„±í™”)</label>
        <div id="time-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
        </div>
    </div>

    <div class="schedule-list" id="schedule-list" style="margin-top: 30px;">
        <h3>í˜„ì¬ ë‚ ì§œ ì˜¤í”ˆëœ ìˆ˜ì—… ëª©ë¡</h3>
        <div id="day-list-content"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://stjmbuhxmdnogmzmeqmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GJe263qFZFStFSXh2oT3AA_D2wUEqmD';

        // 09:00 ~ 23:00 ì‹œê°„ ë°°ì—´ ìƒì„±
        const timeSlots = Array.from({ length: 15 }, (_, i) => `${String(i + 9).padStart(2, '0')}:00`);

        // í•´ë‹¹ ë‚ ì§œì˜ ìŠ¤ì¼€ì¤„ì„ ë¶ˆëŸ¬ì™€ ë²„íŠ¼ ìƒíƒœë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
        async function fetchDaySchedules() {
            const date = document.getElementById('lesson-date').value;
            if (!date) return;

            const res = await fetch(`${SUPABASE_URL}/rest/v1/ClassSchedules?lesson_date=eq.${date}`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const currentSchedules = await res.json();
            renderTimeGrid(currentSchedules, date);
        }

        function renderTimeGrid(currentSchedules, date) {
            const grid = document.getElementById('time-grid');
            const listContent = document.getElementById('day-list-content');
            if (!grid || !listContent) return;

            grid.innerHTML = '';
            listContent.innerHTML = '';

            timeSlots.forEach(time => {
                const schedule = currentSchedules.find(s => s.lesson_time === time);
                const btn = document.createElement('button');

                btn.innerText = time;
                btn.style.padding = "10px";
                btn.style.borderRadius = "8px";
                btn.style.border = "none";
                btn.style.cursor = "pointer";
                btn.style.fontWeight = "bold";

                if (schedule) {
                    btn.style.background = "#339af0";
                    btn.style.color = "white";
                    if (!schedule.is_available) {
                        btn.style.background = "#ff6b6b";
                        btn.innerText += " (ë§ˆê°)";
                    }
                } else {
                    btn.style.background = "#eee";
                    btn.style.color = "#666";
                }

                btn.onclick = () => toggleSchedule(date, time, schedule);
                grid.appendChild(btn);

                if (schedule) {
                    const item = document.createElement('div');
                    item.style = "padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;";
                    item.innerHTML = `<span>${time} - ${schedule.is_available ? 'ì˜ˆì•½ ê°€ëŠ¥' : 'ì˜ˆì•½ ì™„ë£Œ'}</span>`;
                    listContent.appendChild(item);
                }
            });
        }

        async function toggleSchedule(date, time, existingSchedule) {
            if (existingSchedule) {
                if (!existingSchedule.is_available) return alert("ì´ë¯¸ ì˜ˆì•½ëœ ìˆ˜ì—…ì€ ì·¨ì†Œë¥¼ ë¨¼ì € í•˜ì„¸ìš”.");
                await fetch(`${SUPABASE_URL}/rest/v1/ClassSchedules?id=eq.${existingSchedule.id}`, {
                    method: 'DELETE',
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
            } else {
                await fetch(`${SUPABASE_URL}/rest/v1/ClassSchedules`, {
                    method: 'POST',
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lesson_date: date, lesson_time: time, is_available: true })
                });
            }
            fetchDaySchedules();
        }

        let adminCurrentDate = new Date();
        let allReservations = [];

        async function loadAdminDashboard() {
            try {
                // 1. ì˜ˆì•½ ë°ì´í„°ì™€ í•™ìƒ ë°ì´í„°ë¥¼ ê°ê° ê°€ì ¸ì˜µë‹ˆë‹¤.
                const [resReservations, resStudents] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/Reservations?select=*`, {
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    }),
                    // Students í…Œì´ë¸”ì—ì„œ idì™€ ëŒ€ë¬¸ì 'Name'ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    fetch(`${SUPABASE_URL}/rest/v1/Students?select=id,Name`, {
                        headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                    })
                ]);

                if (!resReservations.ok || !resStudents.ok) throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");

                const reservations = await resReservations.json();
                const students = await resStudents.json();

                // 2. í•™ìƒ IDë¥¼ keyë¡œ, ëŒ€ë¬¸ì Nameì„ valueë¡œ í•˜ëŠ” ì§€ë„ë¥¼ ë§Œë“­ë‹ˆë‹¤.
                const studentMap = {};
                students.forEach(s => {
                    studentMap[s.id] = s.Name; // image_0a02a6.pngì˜ ëŒ€ë¬¸ì 'Name' ë°˜ì˜
                });

                // 3. ì˜ˆì•½ ë°ì´í„°ì˜ student_idì™€ í•™ìƒ ì§€ë„ì˜ idë¥¼ ë§¤ì¹­ì‹œì¼œ ì´ë¦„ì„ ë„£ìŠµë‹ˆë‹¤.
                allReservations = reservations.map(r => ({
                    ...r,
                    student_name: studentMap[r.student_id] || `ID:${r.student_id}`
                }));

                console.log("ì´ë¦„ ë§¤ì¹­ ì™„ë£Œ:", allReservations);
                renderAdminCalendar();

            } catch (err) {
                console.error("ëŒ€ì‹œë³´ë“œ ì—ëŸ¬:", err);
                allReservations = [];
                renderAdminCalendar();
            }
        }

        function renderAdminCalendar() {
            const grid = document.getElementById('admin-calendar-grid');
            const monthText = document.getElementById('admin-current-month');
            if (!grid || !monthText) return;

            grid.innerHTML = '';
            const year = adminCurrentDate.getFullYear();
            const month = adminCurrentDate.getMonth();
            monthText.innerText = `${year}ë…„ ${month + 1}ì›”`;

            // 2. ìš”ì¼ í—¤ë”ë¥¼ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            days.forEach(d => {
                const h = document.createElement('div');
                h.className = 'calendar-header';
                h.innerText = d;
                grid.appendChild(h);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            // [2] ë¹ˆ ì¹¸ ì±„ìš°ê¸° ë¶€ë¶„ ìˆ˜ì •
            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'calendar-day empty'; // ğŸ‘ˆ í…Œë‘ë¦¬ê°€ ìƒê¸°ë„ë¡ í´ë˜ìŠ¤ ì¶”ê°€
                grid.appendChild(emptyDiv);
            }

            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.innerHTML = `<div class="day-number">${d}</div>`;

                const dayRes = allReservations.filter(r => r.lesson_date === dateStr);
                dayRes.sort((a, b) => a.lesson_time.localeCompare(b.lesson_time));

                dayRes.forEach(res => {
                    const badge = document.createElement('div');
                    badge.className = 'admin-res-badge';

                    // [ì¶”ê°€] í´ë¦­í•˜ë©´ ì‚­ì œ í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ë„ë¡ ì—°ê²°
                    const displayName = res.student_name || `ID:${res.student_id}`;
                    badge.onclick = () => deleteReservation(res.id, displayName);
                    badge.style.cursor = 'pointer'; // í´ë¦­ ê°€ëŠ¥í•˜ë‹¤ëŠ” í‘œì‹œ

                    badge.innerHTML = `
        <span class="res-time">${res.lesson_time}</span>
        <span>${displayName}</span>
    `;
                    dayDiv.appendChild(badge);
                });
                grid.appendChild(dayDiv);
            }
        } // <--- renderAdminCalendar í•¨ìˆ˜ê°€ ì—¬ê¸°ì„œ ì •í™•íˆ ë‹«í˜€ì•¼ í•©ë‹ˆë‹¤.

        async function deleteReservation(resId, studentName) {
            // 1. ì‹¤ìˆ˜ë¡œ ì§€ìš°ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•œ í™•ì¸ì°½
            if (!confirm(`[${studentName}] í•™ìƒì˜ ì˜ˆì•½ì„ ê°•ì œë¡œ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                // 2. Supabase DELETE ìš”ì²­
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Reservations?id=eq.${resId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (res.ok) {
                    alert("ì˜ˆì•½ì´ ì •ìƒì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // 3. ë°ì´í„° ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì„œ í™”ë©´ ê°±ì‹ 
                    loadAdminDashboard();
                } else {
                    const errorData = await res.json();
                    throw new Error(errorData.message || "ì‚­ì œ ì‹¤íŒ¨");
                }
            } catch (err) {
                console.error("ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
                alert("ì˜ˆì•½ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message);
            }
        }

        function changeAdminMonth(offset) {
            adminCurrentDate.setMonth(adminCurrentDate.getMonth() + offset);
            loadAdminDashboard();
        }

        window.addEventListener('load', () => {
            loadAdminDashboard();
        });
    </script>

    <div class="container">
        <div class="card">
            <h2>ğŸ“… ìˆ˜ì—… ì‹œê°„í‘œ ê°œì„¤</h2>
        </div>
    </div>

    <div class="container" style="margin-top: 30px; max-width: 1000px;">
        <div class="card">
            <h2>ğŸ“… ì „ì²´ ìˆ˜ì—… ë° ì˜ˆì•½ í˜„í™©</h2>
            <div id="admin-calendar-header"
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button onclick="changeAdminMonth(-1)">â—€</button>
                <h3 id="admin-current-month">2025ë…„ 12ì›”</h3>
                <button onclick="changeAdminMonth(1)">â–¶</button>
            </div>
            <div id="admin-calendar-grid" class="calendar-grid">
            </div>
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <div id="schedule-list"></div>
    </div>
</body>

</html>