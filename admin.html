<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ê´€ë¦¬ì ëª¨ë“œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #339af0; --red: #ff6b6b; --gray: #f8f9fa; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--gray); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .admin-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 100%; max-width: 500px; margin-bottom: 20px; }
        h2, h3 { color: var(--blue); margin-top: 0; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: var(--blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; margin-top: 10px; }
        .admin-table th { background: #f1f3f5; padding: 12px; font-size: 13px; border-bottom: 2px solid #dee2e6; }
        .admin-table td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        .slot-input { width: 45px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 5px; }
        .btn-save { background: #28a745; padding: 6px 10px; font-size: 12px; width: auto; margin: 0; }
        .btn-del { background: #dc3545; padding: 6px 10px; font-size: 12px; width: auto; margin: 0; }

        /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
        #admin-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #dee2e6; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden; width: 100%; max-width: 800px; }
        .calendar-header { background: #f8f9fa; font-weight: bold; text-align: center; padding: 10px; font-size: 12px; }
        .calendar-day { background: white; min-height: 100px; padding: 5px; display: flex; flex-direction: column; gap: 2px; }
        .day-number { font-weight: bold; font-size: 12px; margin-bottom: 5px; }
        .admin-res-badge { background: #e7f5ff; color: #0056b3; border-left: 3px solid #0056b3; padding: 2px 4px; font-size: 11px; border-radius: 3px; cursor: pointer; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div class="admin-card">
        <h2>ğŸ“… ìˆ˜ì—… ì‹œê°„í‘œ ê°œì„¤</h2>
        <div class="input-group">
            <label>ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="lesson-date" onchange="fetchDaySchedules()">
        </div>
        <div id="time-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;"></div>
    </div>

    <div class="admin-card" style="max-width: 800px;">
        <h3>ğŸ—“ï¸ ì „ì²´ ì˜ˆì•½ í˜„í™©</h3>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="changeAdminMonth(-1)" style="width:auto; padding:5px 15px;">â—€</button>
            <h3 id="admin-current-month" style="margin:0;">2025ë…„ 12ì›”</h3>
            <button onclick="changeAdminMonth(1)" style="width:auto; padding:5px 15px;">â–¶</button>
        </div>
        <div id="admin-calendar-grid"></div>
    </div>

    <div class="admin-card" style="max-width: 600px;">
        <h3>ğŸ‘¥ í•™ìƒ ìˆ˜ì—… íšŸìˆ˜ ê´€ë¦¬</h3>
        <div id="student-management-container">
            <p style="text-align: center; color: #666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <h4>â• ìƒˆ í•™ìƒ ë“±ë¡</h4>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="new-student-name" placeholder="í•™ìƒ ì´ë¦„">
            <input type="number" id="initial-slots" value="4" style="width: 80px;">
            <button onclick="addNewStudent()" style="width: auto; margin: 0; background: #28a745;">ì¶”ê°€</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://stjmbuhxmdnogmzmeqmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GJe263qFZFStFSXh2oT3AA_D2wUEqmD';
        let adminCurrentDate = new Date();
        let currentMonthKey = "";

        // 1. ì´ˆê¸° ë¡œë“œ
        window.onload = () => {
            updateMonthDisplay();
            loadAdminDashboard();
        };

        function updateMonthDisplay() {
            const year = adminCurrentDate.getFullYear();
            const month = adminCurrentDate.getMonth() + 1;
            document.getElementById('admin-current-month').innerText = `${year}ë…„ ${month}ì›”`;
            currentMonthKey = `${year}-${String(month).padStart(2, '0')}`;
        }

        async function loadAdminDashboard() {
            const container = document.getElementById('student-management-container');
            try {
                // 400 ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ë‚ ì§œ í•„í„°ë§ ìˆ˜ì •
                const lastDay = new Date(adminCurrentDate.getFullYear(), adminCurrentDate.getMonth() + 1, 0).getDate();
                const start = `${currentMonthKey}-01`;
                const end = `${currentMonthKey}-${lastDay}`;

                const [stdRes, slotRes, resRes] = await Promise.all([
                    fetch(`${SUPABASE_URL}/rest/v1/Students?select=*`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }),
                    fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots?month_key=eq.${currentMonthKey}`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } }),
                    fetch(`${SUPABASE_URL}/rest/v1/Reservations?lesson_date=gte.${start}&lesson_date=lte.${end}`, { headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` } })
                ]);

                const students = await stdRes.json();
                const slotsData = await slotRes.json();
                const reservations = await resRes.json();

                // í•™ìƒ ê´€ë¦¬ í…Œì´ë¸” ë Œë”ë§
                let html = `<table class="admin-table"><thead><tr><th>ì´ë¦„</th><th>ë¶€ì—¬</th><th>ì‚¬ìš©</th><th>ì”ì—¬</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
                students.forEach(s => {
                    const slot = slotsData.find(sl => sl.student_id === s.id);
                    const allowed = slot ? slot.allowed_slots : 0;
                    const used = Array.isArray(reservations) ? reservations.filter(r => r.student_id === s.id).length : 0;
                    const remain = allowed - used;
                    html += `<tr>
                        <td><strong>${s.Name}</strong></td>
                        <td><input type="number" id="slot-${s.id}" value="${allowed}" class="slot-input"></td>
                        <td style="color:blue">${used}</td>
                        <td style="font-weight:bold; color:${remain < 0 ? 'red' : 'black'}">${remain}</td>
                        <td><button onclick="updateMonthlySlot(${s.id})" class="btn-save">ì €ì¥</button></td>
                    </tr>`;
                });
                html += `</tbody></table>`;
                container.innerHTML = html;

                renderCalendar(reservations);
            } catch (e) {
                container.innerHTML = "ì˜¤ë¥˜ ë°œìƒ: " + e.message;
            }
        }

        function renderCalendar(reservations) {
            const grid = document.getElementById('admin-calendar-grid');
            grid.innerHTML = '';
            ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => grid.innerHTML += `<div class="calendar-header">${d}</div>`);

            const year = adminCurrentDate.getFullYear();
            const month = adminCurrentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day"></div>`;
            for (let d = 1; d <= lastDate; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayRes = Array.isArray(reservations) ? reservations.filter(r => r.lesson_date === dateStr) : [];
                let resHtml = dayRes.map(r => `<div class="admin-res-badge" onclick="deleteRes(${r.id})">${r.lesson_time} ${r.student_name || 'í•™ìƒ'}</div>`).join('');
                grid.innerHTML += `<div class="calendar-day"><div class="day-number">${d}</div>${resHtml}</div>`;
            }
        }

        async function addNewStudent() {
            const name = document.getElementById('new-student-name').value;
            const slots = document.getElementById('initial-slots').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            // ì˜¤ë¥˜ì˜ í•µì‹¬: Students í…Œì´ë¸”ì˜ total_slots ì œì•½ì¡°ê±´ íšŒí”¼ë¥¼ ìœ„í•´ 0ì´ë¼ë„ ë³´ëƒ„
            const res = await fetch(`${SUPABASE_URL}/rest/v1/Students`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify({ Name: name, total_slots: 0 }) 
            });
            const data = await res.json();
            if(res.ok) {
                await updateMonthlySlot(data[0].id, slots);
                alert("ë“±ë¡ ì™„ë£Œ!");
                loadAdminDashboard();
            }
        }

        async function updateMonthlySlot(sid, val) {
            const count = val || document.getElementById(`slot-${sid}`).value;
            await fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots`, {
                method: 'POST',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
                body: JSON.stringify({ student_id: sid, month_key: currentMonthKey, allowed_slots: parseInt(count) })
            });
            if(!val) alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadAdminDashboard();
        }

        function changeAdminMonth(offset) {
            adminCurrentDate.setMonth(adminCurrentDate.getMonth() + offset);
            updateMonthDisplay();
            loadAdminDashboard();
        }

        async function deleteRes(rid) {
            if(!confirm("ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`${SUPABASE_URL}/rest/v1/Reservations?id=eq.${rid}`, {
                method: 'DELETE',
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            loadAdminDashboard();
        }
    </script>
</body>
</html>