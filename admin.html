<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìˆ˜ì—… ê´€ë¦¬ì ëª¨ë“œ - í†µí•©ë³¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #339af0; --red: #ff6b6b; --gray: #f8f9fa; --green: #28a745; }
        body { font-family: 'Noto Sans KR', sans-serif; background: var(--gray); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .admin-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); width: 100%; max-width: 600px; margin-bottom: 20px; }
        h2, h3 { color: var(--blue); margin-top: 0; text-align: center; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        
        /* ì‹œê°„í‘œ ê°œì„¤ ê·¸ë¦¬ë“œ */
        .time-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px; }
        .time-btn { padding: 10px; background: #eee; color: #333; border-radius: 8px; font-size: 13px; text-align: center; cursor: pointer; border: 1px solid transparent; }
        .time-btn.active { background: var(--blue); color: white; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .admin-table th { background: #f1f3f5; padding: 10px; font-size: 13px; border-bottom: 2px solid #dee2e6; }
        .admin-table td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; font-size: 14px; }
        .slot-input { width: 50px; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 5px; }
        
        /* ë‹¬ë ¥ */
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #dee2e6; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .cal-header { background: #f8f9fa; padding: 10px; text-align: center; font-weight: bold; font-size: 12px; }
        .cal-day { background: white; min-height: 80px; padding: 5px; font-size: 11px; }
        .res-item { background: #e7f5ff; color: #0056b3; padding: 2px; margin-top: 2px; border-radius: 3px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="admin-card">
        <h2>ğŸ“… ìˆ˜ì—… ì‹œê°„í‘œ ê°œì„¤</h2>
        <div class="input-group">
            <label>ë‚ ì§œ ì„ íƒ</label>
            <input type="date" id="lesson-date" onchange="fetchDaySchedules()">
        </div>
        <div id="time-grid" class="time-grid"></div>
        <p style="font-size: 12px; color: #666; text-align: center; margin-top: 10px;">* ì‹œê°„ì„ í´ë¦­í•˜ì—¬ í™œì„±í™”(íŒŒë€ìƒ‰) í•˜ì„¸ìš”.</p>
    </div>

    <div class="admin-card">
        <h3>ğŸ‘¥ í•™ìƒ ìˆ˜ì—… íšŸìˆ˜ ê´€ë¦¬</h3>
        <div id="student-list-container">
            <p style="text-align: center;">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <h4>â• ìƒˆ í•™ìƒ ë“±ë¡</h4>
        <div style="display: flex; gap: 8px;">
            <input type="text" id="new-name" placeholder="í•™ìƒ ì´ë¦„">
            <input type="number" id="new-slots" value="4" style="width: 80px;">
            <button onclick="addNewStudent()" style="width: 100px; background: var(--green);">ë“±ë¡</button>
        </div>
    </div>

    <div class="admin-card">
        <h3>ğŸ—“ï¸ ì „ì²´ ì˜ˆì•½ í˜„í™©</h3>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button onclick="moveMonth(-1)" style="width:auto; padding:5px 15px;">â—€</button>
            <span id="current-month-label" style="font-weight:bold;"></span>
            <button onclick="moveMonth(1)" style="width:auto; padding:5px 15px;">â–¶</button>
        </div>
        <div id="calendar-grid"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://stjmbuhxmdnogmzmeqmt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GJe263qFZFStFSXh2oT3AA_D2wUEqmD';
        const headers = { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json' };

        let viewDate = new Date();

        window.onload = () => {
            initTimeGrid();
            refreshDashboard();
        };

        // --- 1. ì‹œê°„í‘œ ê´€ë¦¬ ê¸°ëŠ¥ ---
        function initTimeGrid() {
            const grid = document.getElementById('time-grid');
            const times = ["14:00", "15:00", "16:00", "17:00", "18:00", "19:00", "20:00", "21:00"];
            grid.innerHTML = times.map(t => `<div class="time-btn" id="time-${t.replace(':','')}" onclick="toggleSchedule('${t}')">${t}</div>`).join('');
        }

        async function fetchDaySchedules() {
            const date = document.getElementById('lesson-date').value;
            if(!date) return;
            
            const res = await fetch(`${SUPABASE_URL}/rest/v1/Schedules?lesson_date=eq.${date}`, { headers });
            const data = await res.json();
            
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
            data.forEach(s => {
                const id = `time-${s.lesson_time.replace(':','')}`;
                if(document.getElementById(id)) document.getElementById(id).classList.add('active');
            });
        }

        async function toggleSchedule(time) {
            const date = document.getElementById('lesson-date').value;
            if(!date) return alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");

            const btn = document.getElementById(`time-${time.replace(':','')}`);
            const isActive = btn.classList.contains('active');

            if(!isActive) {
                await fetch(`${SUPABASE_URL}/rest/v1/Schedules`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ lesson_date: date, lesson_time: time, is_active: true })
                });
            } else {
                await fetch(`${SUPABASE_URL}/rest/v1/Schedules?lesson_date=eq.${date}&lesson_time=eq.${time}`, {
                    method: 'DELETE', headers
                });
            }
            fetchDaySchedules();
        }

        // --- 2. í•™ìƒ ë° ì˜ˆì•½ ê´€ë¦¬ ê¸°ëŠ¥ ---
        async function refreshDashboard() {
            const monthKey = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}`;
            document.getElementById('current-month-label').innerText = `${viewDate.getFullYear()}ë…„ ${viewDate.getMonth()+1}ì›”`;

            const [stdRes, slotRes, resRes] = await Promise.all([
                fetch(`${SUPABASE_URL}/rest/v1/Students?select=*`, { headers }),
                fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots?month_key=eq.${monthKey}`, { headers }),
                fetch(`${SUPABASE_URL}/rest/v1/Reservations?lesson_date=like.${monthKey}*`, { headers })
            ]);

            const students = await stdRes.json();
            const slots = await slotRes.json();
            const reservations = Array.isArray(await resRes.json()) ? await resRes.json() : [];

            renderStudentTable(students, slots, reservations, monthKey);
            renderCalendar(reservations);
        }

        function renderStudentTable(students, slots, reservations, monthKey) {
            let html = `<table class="admin-table"><thead><tr><th>ì´ë¦„</th><th>ë¶€ì—¬</th><th>ì”ì—¬</th><th>ê´€ë¦¬</th></tr></thead><tbody>`;
            students.forEach(s => {
                const slot = slots.find(sl => sl.student_id === s.id) || { allowed_slots: 0 };
                const used = reservations.filter(r => r.student_id === s.id).length;
                html += `<tr>
                    <td>${s.Name}</td>
                    <td><input type="number" id="input-${s.id}" value="${slot.allowed_slots}" class="slot-input"></td>
                    <td style="font-weight:bold; color:${(slot.allowed_slots - used) < 0 ? 'red' : 'black'}">${slot.allowed_slots - used}</td>
                    <td><button onclick="updateSlot(${s.id}, '${monthKey}')" style="padding:4px 8px; font-size:12px; width:auto;">ì €ì¥</button></td>
                </tr>`;
            });
            document.getElementById('student-list-container').innerHTML = html + `</tbody></table>`;
        }

        async function addNewStudent() {
            const name = document.getElementById('new-name').value;
            const initialSlots = document.getElementById('new-slots').value;
            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            // ì˜¤ë¥˜ í•´ê²° í¬ì¸íŠ¸: total_slotsì— 0ì´ë¼ë„ ê°’ì„ ë„£ì–´ ë³´ëƒ„
            const res = await fetch(`${SUPABASE_URL}/rest/v1/Students`, {
                method: 'POST',
                headers: { ...headers, 'Prefer': 'return=representation' },
                body: JSON.stringify({ Name: name, total_slots: 0 }) 
            });
            
            if(res.ok) {
                const data = await res.json();
                const monthKey = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}`;
                await updateSlot(data[0].id, monthKey, initialSlots);
                alert("í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                refreshDashboard();
            } else {
                alert("ë“±ë¡ ì‹¤íŒ¨: DB ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.");
            }
        }

        async function updateSlot(sid, monthKey, val) {
            const count = val || document.getElementById(`input-${sid}`).value;
            await fetch(`${SUPABASE_URL}/rest/v1/StudentMonthlySlots`, {
                method: 'POST',
                headers: { ...headers, 'Prefer': 'resolution=merge-duplicates' },
                body: JSON.stringify({ student_id: sid, month_key: monthKey, allowed_slots: parseInt(count) })
            });
            if(!val) alert("ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            refreshDashboard();
        }

        function renderCalendar(reservations) {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => grid.innerHTML += `<div class="cal-header">${d}</div>`);

            const firstDay = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
            const lastDate = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="cal-day"></div>`;
            for(let d=1; d<=lastDate; d++) {
                const dateStr = `${viewDate.getFullYear()}-${String(viewDate.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayRes = reservations.filter(r => r.lesson_date === dateStr);
                const resHtml = dayRes.map(r => `<div class="res-item" onclick="deleteRes(${r.id})">${r.lesson_time} ${r.student_name}</div>`).join('');
                grid.innerHTML += `<div class="cal-day"><strong>${d}</strong>${resHtml}</div>`;
            }
        }

        async function deleteRes(rid) {
            if(!confirm("ì´ ì˜ˆì•½ì„ ì‚­ì œí• ê¹Œìš”?")) return;
            await fetch(`${SUPABASE_URL}/rest/v1/Reservations?id=eq.${rid}`, { method: 'DELETE', headers });
            refreshDashboard();
        }

        function moveMonth(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            refreshDashboard();
        }
    </script>
</body>
</html>